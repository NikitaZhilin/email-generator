<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com https://cdnjs.cloudflare.com; img-src 'self' data: blob: https:; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com https://cdnjs.cloudflare.com; connect-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com blob:;">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∏—Å—å–º–∞ "–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏"</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 50px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .left-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 5px;
        }
        #resizer {
            background: transparent;
        }
        #resizer:hover #resizerHandle {
            background: #667eea;
        }
        .preview-frame {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: white;
            width: 100%;
            min-height: 500px;
        }
        #codeView {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            color: #212529;
            padding: 10px;
            line-height: 1.5;
        }
        #codeView:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .tooltip {
            font-family: inherit;
        }
        .tooltip-inner {
            max-width: 400px;
            padding: 12px 16px;
            background-color: #212529;
            text-align: left;
            white-space: pre-line;
            line-height: 1.5;
        }
        .bs-tooltip-bottom .tooltip-arrow::before,
        .bs-tooltip-top .tooltip-arrow::before {
            border-bottom-color: #212529;
            border-top-color: #212529;
        }
        .dropdown-menu {
            min-width: 280px;
            padding: 8px 0;
        }
        .dropdown-item {
            padding: 8px 16px;
            font-weight: 500;
        }
        .dropdown-item small {
            padding-left: 32px;
            display: block;
            margin-top: 2px;
        }
        .dropdown-item i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }
        .dropdown-divider {
            margin: 8px 0;
        }
        .employee-form-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6 !important;
            border-radius: 8px;
            overflow: hidden;
        }
        .employee-form-card .accordion-button {
            background: white;
            color: #333;
            font-weight: 600;
            box-shadow: none !important;
        }
        .employee-form-card .accordion-button:hover {
            background: #f8f9fa;
        }
        .employee-form-card .accordion-button:not(.collapsed) {
            background: #e9ecef;
            color: #495057;
        }
        .employee-form-card .accordion-button::after {
            display: none;
        }
        .employee-form-card .accordion-button .bi-chevron-down {
            transition: transform 0.3s;
        }
        .employee-form-card .accordion-button:not(.collapsed) .bi-chevron-down {
            transform: rotate(180deg);
        }
        .form-section h6 button {
            color: #495057;
            font-weight: 600;
            font-size: 1rem;
        }
        .form-section h6 button:hover {
            color: #667eea;
        }
        .form-section h6 button:not(.collapsed) .bi-chevron-down {
            transform: rotate(180deg);
        }
        .form-section h6 button .bi-chevron-down {
            transition: transform 0.3s;
        }
        .form-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        /* –û—Ç—Å—Ç—É–ø –¥–ª—è textarea –æ—Ç —Ç–µ–∫—Å—Ç–∞ –¥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
        .form-control.description,
        .form-control.additional-text {
            padding-right: 8px !important;
        }
        #saveIndicator {
            transition: opacity 0.3s;
            opacity: 0;
        }
        #saveIndicator.show {
            opacity: 1;
        }
        .border-danger {
            border: 2px solid #dc3545 !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="bi bi-people-fill"></i> –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–∏—Å—å–º–∞</h1>
            <p class="mb-0">–ó–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –Ω–æ–≤—ã–º–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º–∏</p>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row" id="mainRow" style="display: flex; flex-wrap: nowrap;">
            <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –§–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="left-panel" id="leftPanel" style="flex: 0 0 540px; min-width: 540px;">
                <div class="form-section">
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-person-plus-fill"></i> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h5>
                            <div>
                                <button class="btn btn-outline-danger btn-sm me-2" onclick="clearAllData()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ">
                                    <i class="bi bi-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="addEmployeeForm()">
                                    <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                                </button>
                            </div>
                        </div>
                        
                        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö -->
                        <div class="p-3 mb-3 bg-light rounded border">
                            <div class="d-flex align-items-center gap-3 flex-wrap">
                                <label class="text-muted small mb-0">
                                    <i class="bi bi-images"></i> –§–æ—Ç–æ –¥–ª—è –≤—Å–µ—Ö:
                                </label>
                                <div class="input-group input-group-sm" style="max-width: 400px;">
                                    <span class="input-group-text text-muted" style="max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.75rem;">
                                        https://nikita-zhilin.file.dalee.ru/dalee_sotrud/
                                    </span>
                                    <input type="text" class="form-control" id="photoTask" placeholder="DIHR-931_20.02.2026" value="" onchange="updateAllPhotoUrls()">
                                </div>
                                <small class="text-muted">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ ‚Äî —Ñ–æ—Ç–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è –∫–æ –≤—Å–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <span id="saveIndicator" class="text-muted small">
                                <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ
                            </span>
                            <div class="d-flex gap-2 align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-success btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                                        <i class="bi bi-file-earmark-arrow-down"></i> –ò–º–ø–æ—Ä—Ç
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item" onclick="document.getElementById('pdfFile').click()">
                                                <i class="bi bi-file-earmark-pdf text-danger"></i> –ò–º–ø–æ—Ä—Ç –∏–∑ PDF
                                            </button>
                                            <small class="dropdown-item text-muted" style="font-size: 0.75rem;">
                                                üìÑ Word/PDF —Ñ–∞–π–ª ‚Üí –∞–≤—Ç–æ-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                                            </small>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item" onclick="document.getElementById('docxFile').click()">
                                                <i class="bi bi-file-earmark-word text-primary"></i> –ò–º–ø–æ—Ä—Ç –∏–∑ DOCX
                                            </button>
                                            <small class="dropdown-item text-muted" style="font-size: 0.75rem;">
                                                üìÑ Word —Ñ–∞–π–ª ‚Üí –∞–≤—Ç–æ-—Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                                            </small>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li>
                                            <button class="dropdown-item" onclick="document.getElementById('importFile').click()">
                                                <i class="bi bi-file-earmark-json text-warning"></i> –ò–º–ø–æ—Ä—Ç –∏–∑ JSON
                                            </button>
                                            <small class="dropdown-item text-muted" style="font-size: 0.75rem;">
                                                üìÇ JSON —Ñ–∞–π–ª ‚Üí –ø–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
                                            </small>
                                        </li>
                                    </ul>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" onclick="exportConfig()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON">
                                    <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç
                                </button>
                            </div>
                        </div>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importConfig(this)">
                        <input type="file" id="docxFile" accept=".docx,.doc" style="display: none;" onchange="importFromDOCX(this)">
                        <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="importFromPDF(this)">
                    </div>
                    <div id="employeesForms">
                        <!-- –°—é–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ -->
                    </div>
                </div>

                <div class="form-section">
                    <h6 class="mb-3">
                        <button class="btn btn-link text-decoration-none p-0 collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#settingsCollapse" aria-expanded="false">
                            <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∏—Å—å–º–∞
                            <i class="bi bi-chevron-down ms-2"></i>
                        </button>
                    </h6>
                    <div id="settingsCollapse" class="collapse">
                        <div class="alert alert-info alert-dismissible fade show mb-3" role="alert">
                            <small>
                                <strong>–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏:</strong><br>
                                <kbd>Ctrl+S</kbd> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å &nbsp;|&nbsp; 
                                <kbd>Ctrl+E</kbd> –≠–∫—Å–ø–æ—Ä—Ç &nbsp;|&nbsp; 
                                <kbd>Ctrl+P</kbd> –ò–º–ø–æ—Ä—Ç PDF &nbsp;|&nbsp; 
                                <kbd>Ctrl+D</kbd> –ò–º–ø–æ—Ä—Ç DOCX &nbsp;|&nbsp; 
                                <kbd>Ctrl+I</kbd> –ò–º–ø–æ—Ä—Ç JSON &nbsp;|&nbsp; 
                                <kbd>Ctrl+N</kbd> –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ &nbsp;|&nbsp; 
                                <kbd>Ctrl+Shift+C</kbd> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
                            </small>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="typographyEnabled" checked>
                            <label class="form-check-label" for="typographyEnabled">
                                –ü—Ä–∏–º–µ–Ω—è—Ç—å —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫—É (—Ç–∏—Ä–µ, –∫–∞–≤—ã—á–∫–∏-—ë–ª–æ—á–∫–∏, –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã)
                            </label>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">–í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                            <div class="position-relative">
                                <textarea class="form-control" id="introText" rows="3">–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç! –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞—Å—Ç–∏ –≤–º–µ—Å—Ç–µ —Å –≤–∞–º–∏ –∏ –±–ª–∞–≥–æ–¥–∞—Ä—è –≤–∞–º!

–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –Ω–æ–≤–æ –ø—Ä–∏–±—ã–≤—à–∏–º–∏ –∫–æ–ª–ª–µ–≥–∞–º–∏:</textarea>
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å" style="position: absolute; top: 5px; right: 5px;">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">–ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ç–µ–∫—Å—Ç</label>
                            <div class="position-relative">
                                <textarea class="form-control" id="outroText" rows="3">–í—Å–µ–º —Å–ø–∞—Å–∏–±–æ –∏ –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –î–ê–õ–ï–ï!

–ö—Ä—É—Ç—ã—Ö –≤–∞–º –≤—ã—Ö–æ–¥–Ω—ã—Ö ‚Äî –Ω–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ—Ç–¥—ã—Ö–∞—Ç—å &lt;3</textarea>
                                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å" style="position: absolute; top: 5px; right: 5px;">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">–ü–æ–¥–ø–∏—Å—å HR (–ø–æ–¥–≤–∞–ª)</label>
                            <div class="row">
                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="hrName" placeholder="–ò–º—è HR" value="–û–∫—Å–∞–Ω–∞ –í–∞—á–µ–≤—Å–∫–∏—Ö">
                                        <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-2">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="hrPosition" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å HR" value="HR –º–µ–Ω–µ–¥–∂–µ—Ä">
                                        <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
            <div class="col-auto d-flex align-items-center justify-content-center px-1" style="cursor: col-resize; user-select: none; min-width: 20px;" id="resizer">
                <div style="width: 4px; height: 40px; background: #dee2e6; border-radius: 2px; transition: background 0.2s;" id="resizerHandle"></div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div id="rightPanel" style="flex: 1; min-width: 400px; max-height: calc(100vh - 200px); overflow-y: auto; padding-left: 5px;">
                <div class="form-section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0"><i class="bi bi-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
                        <div class="d-flex gap-2">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm active" id="btnPreview" onclick="switchView('preview')" title="–í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
                                    <i class="bi bi-eye"></i> –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="btnCode" onclick="switchView('code')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä HTML-–∫–æ–¥–∞">
                                    <i class="bi bi-code-slash"></i> –ö–æ–¥
                                </button>
                            </div>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnCopyCode" onclick="copyCode()" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å HTML-–∫–æ–¥" style="display: none;">
                                <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                            <button class="btn btn-success btn-sm" onclick="downloadHTML()">
                                <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å HTML
                            </button>
                        </div>
                    </div>
                    <div id="previewContainer">
                        <iframe id="previewFrame" class="preview-frame w-100"></iframe>
                    </div>
                    <div id="codeContainer" style="display: none;">
                        <textarea id="codeView" class="form-control font-monospace" style="height: calc(100vh - 350px); min-height: 500px; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; white-space: pre; overflow-x: auto;" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/typograf@6.1.0/dist/typograf.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/mammoth/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let employees = [];
        const STORAGE_KEY = 'newsletter_generator_data';
        let formCounter = 0;
        const DEFAULT_HEADER_LOGO = 'https://nikita-zhilin.file.dalee.ru/dalee_sotrud/DIHR-768_13.09.2024/logotop.jpg';
        let saveTimeout = null;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        } else {
            console.warn('PDF.js –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è');
        }
        
        // –°–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
        function sanitizeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è URL (–∑–∞—â–∏—Ç–∞ –æ—Ç javascript:)
        function sanitizeURL(url) {
            if (!url) return '';
            // –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ http, https, data (–¥–ª—è base64)
            if (!/^https?:\/\//i.test(url) && !/^data:image/i.test(url)) {
                return 'https://' + url; // –î–æ–±–∞–≤–ª—è–µ–º https –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            }
            return url;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¢–∏–ø–æ–≥—Ä–∞—Ñ–∞
        let typograf;
        try {
            typograf = new Typograf({
                locale: 'ru',
                htmlEntity: { type: 'none' } // –ù–µ –∫–æ–¥–∏—Ä—É–µ–º HTML-—Å—É—â–Ω–æ—Å—Ç–∏
            });
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Typograf:', e);
            // –§–æ–ª–ª–±—ç–∫ - –ø—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è
            typograf = {
                execute: function(text) { return text; }
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∞–≤–æ–∫ –ø–æ—Å–ª–µ Typograf
        function applyAdditionalTypography(text) {
            if (!text) return '';
            
            // –ù–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª –ø–æ—Å–ª–µ —á–∏—Å–ª–∞ (–≥–æ–¥, –ª–µ—Ç)
            text = text.replace(/(\d)\s([–≥–æ–¥–≥–ª–µ—Ç])/gi, '$1\u00A0$2');
            
            return text;
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function addEmployeeForm(data = null) {
            formCounter++;
            const id = data?.id || formCounter;
            
            const container = document.getElementById('employeesForms');
            const formDiv = document.createElement('div');
            formDiv.className = 'employee-form-card mb-2 border rounded';
            formDiv.dataset.id = id;
            formDiv.innerHTML = `
                <div class="accordion-item">
                    <h6 class="accordion-header mb-0">
                        <button class="accordion-button collapsed w-100 text-start p-3 border-0 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${id}" aria-expanded="false">
                            <i class="bi bi-person-badge me-2"></i>
                            <span class="employee-name-display">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${id}</span>
                            <span class="ms-auto text-muted small" style="font-weight: normal;">
                                <i class="bi bi-chevron-down"></i>
                            </span>
                        </button>
                    </h6>
                    <div id="collapse${id}" class="accordion-collapse collapse" data-bs-parent="#employeesForms">
                        <div class="accordion-body p-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeEmployeeForm(${id})">
                                    <i class="bi bi-trash"></i> –£–¥–∞–ª–∏—Ç—å
                                </button>
                                <div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" onclick="duplicateEmployeeForm(${id})" title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
                                        <i class="bi bi-copy"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="moveEmployeeUp(${id})" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">
                                        <i class="bi bi-arrow-up"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="moveEmployeeDown(${id})" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">
                                        <i class="bi bi-arrow-down"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è *</label>
                                
                                <div class="mb-2">
                                    <label class="form-label small text-muted">URL —Å —Å–µ—Ä–≤–µ—Ä–∞:</label>
                                    <div class="input-group input-group-sm mb-2">
                                        <span class="input-group-text text-muted" style="max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">https://nikita-zhilin.file.dalee.ru/dalee_sotrud/</span>
                                        <input type="text" class="form-control photo-task" placeholder="DIHR-931_20.02.2026" style="max-width: 160px;" value="${data?.photoTask || ''}">
                                        <span class="input-group-text">/</span>
                                        <input type="text" class="form-control photo-image" placeholder="1.jpg" style="max-width: 90px;" value="${data?.photoImage || ''}">
                                        <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="buildPhotoUrl(this)">
                                        <i class="bi bi-link-45deg"></i> –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å URL
                                    </button>
                                </div>
                                
                                <div class="input-group">
                                    <input type="text" class="form-control photo-url" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π URL –∫–∞—Ä—Ç–∏–Ω–∫–∏" value="${data?.photo || ''}">
                                    <select class="form-select photo-format-select" style="max-width: 80px;" onchange="updatePhotoFormat(this)" title="–§–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞">
                                        <option value="jpg"${getFormatFromUrl(data?.photo) === 'jpg' ? ' selected' : ''}>.jpg</option>
                                        <option value="jpeg"${getFormatFromUrl(data?.photo) === 'jpeg' ? ' selected' : ''}>.jpeg</option>
                                        <option value="png"${getFormatFromUrl(data?.photo) === 'png' ? ' selected' : ''}>.png</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–§–ò–û *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control full-name" required value="${data?.fullName || ''}" oninput="updateEmployeeNameDisplay(${id})" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å –∏ –∫–æ–º–∞–Ω–¥–∞ *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control position" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–µ–Ω–µ–¥–∂–µ—Ä SMM –ø—Ä–æ–µ–∫—Ç–æ–≤ –≤ –∫–æ–º–∞–Ω–¥–µ –°–∫–æ—Ç—á" required value="${data?.position || ''}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–ì–æ—Ä–æ–¥ –∏ –≤–æ–∑—Ä–∞—Å—Ç *</label>
                                <div class="input-group">
                                    <input type="text" class="form-control city-age" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, 22 –≥–æ–¥–∞" required value="${data?.cityAge || ''}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–±–∏–æ–≥—Ä–∞—Ñ–∏—è) *</label>
                                <div class="d-flex gap-2">
                                    <textarea class="form-control description flex-grow-1" rows="4" required placeholder="–¢–µ–∫—Å—Ç –±–∏–æ–≥—Ä–∞—Ñ–∏–∏" onblur="updatePreview()">${data?.description || ''}</textarea>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å" style="height: fit-content; align-self: flex-start; margin-top: 0;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <small class="text-muted">–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –Ω–æ–≤–æ–≥–æ –∞–±–∑–∞—Ü–∞. –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ —É–±–µ—Ä—ë—Ç–µ —Ñ–æ–∫—É—Å</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç</label>
                                <div class="d-flex gap-2">
                                    <textarea class="form-control additional-text flex-grow-1" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" onblur="updatePreview()">${data?.additionalText || ''}</textarea>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="clearInput(this)" title="–û—á–∏—Å—Ç–∏—Ç—å" style="height: fit-content; align-self: flex-start; margin-top: 0;">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                                <small class="text-muted">–¢–µ–∫—Å—Ç –ø–æ–¥ –æ—Å–Ω–æ–≤–Ω—ã–º –±–ª–æ–∫–æ–º (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ). –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ —É–±–µ—Ä—ë—Ç–µ —Ñ–æ–∫—É—Å</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(formDiv);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            formDiv.querySelectorAll('input, textarea').forEach(field => {
                field.addEventListener('input', () => {
                    saveToStorage();
                    updatePreview();
                });
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
            if (data?.fullName) {
                setTimeout(() => updateEmployeeNameDisplay(id), 0);
            }
            
            // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É
            const collapseElement = new bootstrap.Collapse(document.getElementById(`collapse${id}`), {
                toggle: true
            });

            updatePreview();
            saveToStorage();
            
            // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏, –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ
            const task = document.getElementById('photoTask')?.value.trim();
            if (task) {
                updateAllPhotoUrls();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ
        function updateEmployeeNameDisplay(id) {
            const form = document.querySelector(`.employee-form-card[data-id="${id}"]`);
            if (form) {
                const fullName = form.querySelector('.full-name').value.trim();
                const nameDisplay = form.querySelector('.employee-name-display');
                if (fullName && nameDisplay) {
                    nameDisplay.textContent = fullName;
                } else if (nameDisplay) {
                    nameDisplay.textContent = `–°–æ—Ç—Ä—É–¥–Ω–∏–∫ #${id}`;
                }
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
        function clearInput(button) {
            const input = button.parentElement.querySelector('input, textarea');
            if (input) {
                input.value = '';
                input.dispatchEvent(new Event('input', { bubbles: true }));
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function removeEmployeeForm(id) {
            const form = document.querySelector(`.employee-form-card[data-id="${id}"]`);
            if (form) {
                form.remove();
                saveToStorage();
                updatePreview();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º URL –¥–ª—è –≤—Å–µ—Ö (–Ω—É–º–µ—Ä–∞—Ü–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å)
                const task = document.getElementById('photoTask')?.value.trim();
                if (task) {
                    updateAllPhotoUrls();
                }
            }
        }
        
        // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
        function duplicateEmployeeForm(id) {
            const form = document.querySelector(`.employee-form-card[data-id="${id}"]`);
            if (form) {
                const data = {
                    photoTask: form.querySelector('.photo-task').value.trim(),
                    photoImage: form.querySelector('.photo-image').value.trim(),
                    photo: form.querySelector('.photo-url').value.trim(),
                    fullName: form.querySelector('.full-name').value.trim(),
                    position: form.querySelector('.position').value.trim(),
                    cityAge: form.querySelector('.city-age').value.trim(),
                    description: form.querySelector('.description').value.trim(),
                    additionalText: form.querySelector('.additional-text').value.trim()
                };
                
                // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π
                const nextId = ++formCounter;
                const newFormDiv = document.createElement('div');
                newFormDiv.className = 'employee-form-card mb-2 border rounded';
                newFormDiv.dataset.id = nextId;
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º addEmployeeForm –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–æ—Ä–º—ã
                addEmployeeForm({ ...data, id: nextId });
                
                // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É
                setTimeout(() => {
                    const newForm = document.querySelector(`.employee-form-card[data-id="${nextId}"]`);
                    if (newForm) {
                        const collapse = newForm.querySelector('.accordion-collapse');
                        const bsCollapse = new bootstrap.Collapse(collapse, { toggle: true });
                        updateEmployeeNameDisplay(nextId);
                    }
                }, 100);
                
                saveToStorage();
                updatePreview();
            }
        }
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤–≤–µ—Ä—Ö
        function moveEmployeeUp(id) {
            const form = document.querySelector(`.employee-form-card[data-id="${id}"]`);
            if (form && form.previousElementSibling) {
                form.parentNode.insertBefore(form, form.previousElementSibling);
                saveToStorage();
                updatePreview();
            }
        }
        
        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤–Ω–∏–∑
        function moveEmployeeDown(id) {
            const form = document.querySelector(`.employee-form-card[data-id="${id}"]`);
            if (form && form.nextElementSibling) {
                form.parentNode.insertBefore(form.nextElementSibling, form);
                saveToStorage();
                updatePreview();
            }
        }
        
        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL —Ñ–æ—Ç–æ –∏–∑ —á–∞—Å—Ç–µ–π
        function buildPhotoUrl(button) {
            const formCard = button.closest('.employee-form-card');
            const task = formCard.querySelector('.photo-task').value.trim();
            const image = formCard.querySelector('.photo-image').value.trim();

            if (!task || !image) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: DIHR-931_20.02.2026) –∏ –∏–º—è —Ñ–∞–π–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1.jpg)');
                return;
            }

            const fullUrl = sanitizeURL(`https://nikita-zhilin.file.dalee.ru/dalee_sotrud/${task}/${image}`);
            formCard.querySelector('.photo-url').value = fullUrl;
        }
        
        // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Ñ–æ—Ä–º —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
        function getEmployeesFromForms(validate = true) {
            const forms = document.querySelectorAll('.employee-form-card');
            const result = [];
            let hasErrors = false;

            forms.forEach((form) => {
                const photoTask = form.querySelector('.photo-task').value.trim();
                const photoImage = form.querySelector('.photo-image').value.trim();
                let photo = form.querySelector('.photo-url').value.trim();

                // –ï—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è –∑–∞–¥–∞—á–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Ñ–æ—Ä–º–∏—Ä—É–µ–º URL
                if (photoTask && photoImage && !photo) {
                    photo = sanitizeURL(`https://nikita-zhilin.file.dalee.ru/dalee_sotrud/${photoTask}/${photoImage}`);
                } else if (photo) {
                    photo = sanitizeURL(photo);
                }

                const fullName = form.querySelector('.full-name').value.trim();
                const position = form.querySelector('.position').value.trim();
                const cityAge = form.querySelector('.city-age').value.trim();
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫: \n\n ‚Üí <br><br>, –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ \n ‚Üí <br>
                const description = form.querySelector('.description').value.trim()
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
                const additionalText = form.querySelector('.additional-text').value.trim()
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞)
                if (validate && (!photo || !fullName || !position || !cityAge || !description)) {
                    hasErrors = true;
                    form.classList.add('border-danger');
                } else {
                    form.classList.remove('border-danger');
                }

                result.push({
                    id: parseInt(form.dataset.id),
                    photo: photo,
                    fullName: fullName,
                    position: position,
                    cityAge: cityAge,
                    description: description,
                    additionalText: additionalText
                });
            });

            if (hasErrors) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω—ã –∫—Ä–∞—Å–Ω–æ–π —Ä–∞–º–∫–æ–π)');
                return null;
            }

            return result;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage
        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ—Ä–º—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    if (data.employees && data.employees.length > 0) {
                        data.employees.forEach(emp => {
                            // –†–∞–∑–±–∏—Ä–∞–µ–º URL –Ω–∞ —á–∞—Å—Ç–∏ –∏ —Å–∞–Ω–∏—Ç–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                            const urlMatch = emp.photo?.match(/dalee_sotrud\/([^\/]+)\/(.+)$/);
                            addEmployeeForm({
                                ...emp,
                                photoTask: urlMatch ? urlMatch[1] : '',
                                photoImage: urlMatch ? urlMatch[2] : '',
                                fullName: sanitizeHTML(emp.fullName),
                                position: sanitizeHTML(emp.position),
                                cityAge: sanitizeHTML(emp.cityAge),
                                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º <br> –æ–±—Ä–∞—Ç–Ω–æ –≤ \n –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ textarea
                                description: sanitizeHTML(emp.description).replace(/<br><br>/g, '\n\n').replace(/<br>/g, '\n'),
                                additionalText: sanitizeHTML(emp.additionalText).replace(/<br><br>/g, '\n\n').replace(/<br>/g, '\n')
                            });
                        });
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (data.introText) document.getElementById('introText').value = data.introText;
                    if (data.outroText) document.getElementById('outroText').value = data.outroText;
                    if (data.hrName) document.getElementById('hrName').value = data.hrName;
                    if (data.hrPosition) document.getElementById('hrPosition').value = data.hrPosition;
                    if (data.typographyEnabled !== undefined) document.getElementById('typographyEnabled').checked = data.typographyEnabled;
                    
                    updatePreview();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ localStorage
        function saveToStorage() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."
            const saveIndicator = document.getElementById('saveIndicator');
            saveIndicator.innerHTML = '<i class="bi bi-hourglass-split"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            saveIndicator.classList.add('show');

            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä
            if (saveTimeout) clearTimeout(saveTimeout);

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É (debounce)
            saveTimeout = setTimeout(() => {
                try {
                    const data = {
                        employees: getEmployeesFromForms(false), // –ë–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ alert!
                        introText: document.getElementById('introText').value,
                        outroText: document.getElementById('outroText').value,
                        hrName: document.getElementById('hrName').value,
                        hrPosition: document.getElementById('hrPosition').value,
                        typographyEnabled: document.getElementById('typographyEnabled').checked
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ"
                    saveIndicator.innerHTML = '<i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                    setTimeout(() => {
                        saveIndicator.classList.remove('show');
                    }, 2000);
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
                    saveIndicator.innerHTML = '<i class="bi bi-exclamation-circle"></i> –û—à–∏–±–∫–∞!';
                    saveIndicator.style.color = '#dc3545';
                }
            }, 500);
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        function clearAllData() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                document.getElementById('employeesForms').innerHTML = '';
                formCounter = 0;
                localStorage.removeItem(STORAGE_KEY);
                updatePreview();
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ JSON
        function exportConfig() {
            try {
                const data = {
                    employees: getEmployeesFromForms(false),
                    introText: document.getElementById('introText').value,
                    outroText: document.getElementById('outroText').value,
                    hrName: document.getElementById('hrName').value,
                    hrPosition: document.getElementById('hrPosition').value,
                    typographyEnabled: document.getElementById('typographyEnabled').checked,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const json = JSON.stringify(data, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å File System Access API –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø–∞–ø–∫–∏
                if (window.showSaveFilePicker) {
                    exportWithFilePicker(blob);
                } else {
                    // –§–æ–ª–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    exportWithDownload(blob);
                }
            } catch (e) {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message);
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç —Å –≤—ã–±–æ—Ä–æ–º –ø–∞–ø–∫–∏ (File System Access API)
        async function exportWithFilePicker(blob) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: `newsletter-config-${new Date().toISOString().slice(0, 10)}.json`,
                    types: [{
                        description: 'JSON —Ñ–∞–π–ª',
                        accept: { 'application/json': ['.json'] }
                    }]
                });
                const writable = await handle.createWritable();
                await writable.write(blob);
                await writable.close();
            } catch (e) {
                if (e.name !== 'AbortError') {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', e);
                    exportWithDownload(blob);
                }
            }
        }
        
        // –≠–∫—Å–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ download (—Ñ–æ–ª–ª–±—ç–∫)
        function exportWithDownload(blob) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `newsletter-config-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ JSON
        function importConfig(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!confirm('–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                    document.getElementById('employeesForms').innerHTML = '';
                    formCounter = 0;
                    
                    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                    if (data.introText) document.getElementById('introText').value = data.introText;
                    if (data.outroText) document.getElementById('outroText').value = data.outroText;
                    if (data.hrName) document.getElementById('hrName').value = data.hrName;
                    if (data.hrPosition) document.getElementById('hrPosition').value = data.hrPosition;
                    if (data.typographyEnabled !== undefined) document.getElementById('typographyEnabled').checked = data.typographyEnabled;
                    
                    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
                    if (data.employees && data.employees.length > 0) {
                        data.employees.forEach(emp => {
                            const urlMatch = emp.photo?.match(/dalee_sotrud\/([^\/]+)\/(.+)$/);
                            addEmployeeForm({
                                ...emp,
                                photoTask: urlMatch ? urlMatch[1] : '',
                                photoImage: urlMatch ? urlMatch[2] : '',
                                description: emp.description.replace(/<br><br>/g, '\n\n').replace(/<br>/g, '\n'),
                                additionalText: emp.additionalText.replace(/<br><br>/g, '\n\n').replace(/<br>/g, '\n')
                            });
                        });
                    }
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                    updatePreview();
                    alert('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!');
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
                    console.error(e);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }
        
        // –ò–º–ø–æ—Ä—Ç –∏–∑ DOCX
        function importFromDOCX(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (!confirm('–ò–º–ø–æ—Ä—Ç –∏–∑ DOCX –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(function(result) {
                            const text = result.value;
                            parseDOCXText(text);
                        })
                        .catch(function(err) {
                            alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è DOCX: ' + err.message);
                            console.error(err);
                        });
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞');
                    console.error(e);
                }
            };
            reader.readAsArrayBuffer(file);
            input.value = '';
        }
        
        // –ò–º–ø–æ—Ä—Ç –∏–∑ PDF
        async function importFromPDF(input) {
            const file = input.files[0];
            if (!file) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
            if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
                alert('–û—à–∏–±–∫–∞: –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª PDF');
                input.value = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 50 –ú–ë)
            if (file.size > 50 * 1024 * 1024) {
                alert('–û—à–∏–±–∫–∞: –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 50 –ú–ë)');
                input.value = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ PDF.js
            if (typeof pdfjsLib === 'undefined') {
                alert('–û—à–∏–±–∫–∞: PDF.js –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            if (!confirm('–ò–º–ø–æ—Ä—Ç –∏–∑ PDF –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                input.value = '';
                return;
            }
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø—É—Å—Ç–æ–π
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª PDF');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–≥–Ω–∞—Ç—É—Ä—É PDF (%PDF-)
                const firstBytes = new Uint8Array(arrayBuffer, 0, 5);
                const signature = String.fromCharCode.apply(null, firstBytes);
                if (!signature.startsWith('%PDF-')) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞. –≠—Ç–æ –Ω–µ PDF.');
                }
                
                const pdf = await pdfjsLib.getDocument({
                    data: arrayBuffer,
                    useSystemFonts: true,
                    useWorkerFetch: false
                }).promise;
                
                if (pdf.numPages === 0) {
                    throw new Error('PDF –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Å—Ç—Ä–∞–Ω–∏—Ü');
                }
                
                let fullText = '';
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    try {
                        const page = await pdf.getPage(pageNum);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + '\n';
                    } catch (pageError) {
                        console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${pageNum}:`, pageError);
                    }
                }
                
                if (fullText.trim().length === 0) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ç–µ–∫—Å—Ç –∏–∑ PDF. –í–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç.');
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('=== –ò–ó–í–õ–ï–ß–Å–ù–ù–´–ô –¢–ï–ö–°–¢ –ò–ó PDF ===');
                console.log(fullText);
                console.log('=== –ö–û–ù–ï–¶ –¢–ï–ö–°–¢–ê ===');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
                const previewText = fullText.substring(0, 500) + (fullText.length > 500 ? '...' : '');
                console.log('–ü—Ä–µ–≤—å—é:', previewText);
                
                parsePDFText(fullText);
            } catch (e) {
                let errorMessage = '–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF: ' + e.message;
                
                if (e.name === 'InvalidPDFException') {
                    errorMessage = '–û—à–∏–±–∫–∞: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç PDF. –í–æ–∑–º–æ–∂–Ω–æ, —Ñ–∞–π–ª –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –∑–∞—â–∏—â—ë–Ω –ø–∞—Ä–æ–ª–µ–º.';
                } else if (e.name === 'MissingPDFException') {
                    errorMessage = '–û—à–∏–±–∫–∞: –§–∞–π–ª PDF –Ω–µ –Ω–∞–π–¥–µ–Ω.';
                } else if (e.name === 'UnexpectedResponseException') {
                    errorMessage = '–û—à–∏–±–∫–∞: –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç.';
                }
                
                alert(errorMessage);
                console.error('PDF Import Error:', e);
            }
            input.value = '';
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–æ–Ω–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞
        function correctAgeForm(cityAge) {
            // –ò—â–µ–º —á–∏—Å–ª–æ –∏ —Å–ª–æ–≤–æ "–≥–æ–¥/–≥–æ–¥–∞/–ª–µ—Ç"
            return cityAge.replace(/(\d+)\s*(–≥–æ–¥|–≥–æ–¥–∞|–ª–µ—Ç)/i, function(match, age, form) {
                const num = parseInt(age);
                const lastDigit = num % 10;
                const lastTwoDigits = num % 100;
                
                // –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–∫–ª–æ–Ω–µ–Ω–∏–µ
                let correctForm;
                if (lastTwoDigits >= 11 && lastTwoDigits <= 14) {
                    correctForm = '–ª–µ—Ç';
                } else if (lastDigit === 1) {
                    correctForm = '–≥–æ–¥';
                } else if (lastDigit >= 2 && lastDigit <= 4) {
                    correctForm = '–≥–æ–¥–∞';
                } else {
                    correctForm = '–ª–µ—Ç';
                }
                
                return `${age} ${correctForm}`;
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ —Ñ–æ—Ç–æ
        function updatePhotoNumbering() {
            // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –Ω—É–º–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∏–∑ URL
        function getFormatFromUrl(url) {
            if (!url) return 'jpg';
            const match = url.match(/\.(jpg|jpeg|png)$/i);
            return match ? match[1].toLowerCase() : 'jpg';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select
        function updatePhotoFormat(select) {
            const formCard = select.closest('.employee-form-card');
            const urlInput = formCard.querySelector('.photo-url');
            const taskInput = formCard.querySelector('.photo-task');
            const imageInput = formCard.querySelector('.photo-image');
            
            const format = select.value;
            const task = taskInput?.value.trim() || document.getElementById('photoTask').value.trim();
            const currentNumber = imageInput?.value.match(/^(\d+)/)?.[1] || '1';
            
            if (task) {
                const newUrl = `https://nikita-zhilin.file.dalee.ru/dalee_sotrud/${task}/${currentNumber}.${format}`;
                urlInput.value = newUrl;
                imageInput.value = `${currentNumber}.${format}`;
                updatePreview();
                saveToStorage();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –≤—Å–µ—Ö —Ñ–æ—Ç–æ
        function updateAllPhotoUrls() {
            const task = document.getElementById('photoTask').value.trim();
            if (!task) return;
            
            const forms = document.querySelectorAll('.employee-form-card');
            forms.forEach((form, index) => {
                const urlInput = form.querySelector('.photo-url');
                const taskInput = form.querySelector('.photo-task');
                const imageInput = form.querySelector('.photo-image');
                const formatSelect = form.querySelector('.photo-format-select');
                
                const number = index + 1;
                const format = formatSelect?.value || 'jpg';
                
                const photoUrl = `https://nikita-zhilin.file.dalee.ru/dalee_sotrud/${task}/${number}.${format}`;
                urlInput.value = photoUrl;
                taskInput.value = task;
                imageInput.value = `${number}.${format}`;
            });
            
            updatePreview();
            saveToStorage();
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –∏–∑ PDF
        function parsePDFText(text) {
            console.log('=== –ù–ê–ß–ê–õ–û –ü–ê–†–°–ò–ù–ì–ê ===');
            console.log('–î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞:', text.length);
            
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('employeesForms').innerHTML = '';
            formCounter = 0;
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–æ –ø–µ—Ä–≤–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)
            const introMatch = text.match(/(–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç!.*?)(?=–ê–ª—Å—É|–†–µ–≥–∏–Ω–∞|–ê–Ω–∞—Å—Ç–∞—Å–∏—è|–ò–≤–∞–Ω|–°–≤–µ—Ç–ª–∞–Ω–∞|$)/s);
            console.log('–í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç:', introMatch ? '–Ω–∞–π–¥–µ–Ω–æ' : '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            if (introMatch && introMatch[1]) {
                document.getElementById('introText').value = introMatch[1].trim();
            }
            
            // –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ç–µ–∫—Å—Ç (–ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞)
            const outroMatch = text.match(/(–í—Å–µ–º —Å–ø–∞—Å–∏–±–æ.*?)(?:–û–∫—Å–∞–Ω–∞ –í–∞—á–µ–≤—Å–∫–∏—Ö|$)/s);
            console.log('–ó–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ç–µ–∫—Å—Ç:', outroMatch ? '–Ω–∞–π–¥–µ–Ω–æ' : '–Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            if (outroMatch && outroMatch[1]) {
                document.getElementById('outroText').value = outroMatch[1].trim();
            }
            
            // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ –∏–º–µ–Ω–∞–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º split –≤–º–µ—Å—Ç–æ regex exec)
            // –ò—â–µ–º –∏–º–µ–Ω–∞: –ê–ª—Å—É –ë–æ–≥–¥–∞–Ω–æ–≤–∞, –†–µ–≥–∏–Ω–∞ –ê—Ö–º–µ—Ç–æ–≤–∞, –ê–Ω–∞—Å—Ç–∞—Å–∏—è –°—Ç–µ–ø–∞–Ω–æ–≤–∞, –ò–≤–∞–Ω –°–µ–º–µ–Ω–æ–≤, –°–≤–µ—Ç–ª–∞–Ω–∞ –®—É—à–∞—Ä–∏–Ω–∞
            const names = ['–ê–ª—Å—É –ë–æ–≥–¥–∞–Ω–æ–≤–∞', '–†–µ–≥–∏–Ω–∞ –ê—Ö–º–µ—Ç–æ–≤–∞', '–ê–Ω–∞—Å—Ç–∞—Å–∏—è –°—Ç–µ–ø–∞–Ω–æ–≤–∞', '–ò–≤–∞–Ω –°–µ–º–µ–Ω–æ–≤', '–°–≤–µ—Ç–ª–∞–Ω–∞ –®—É—à–∞—Ä–∏–Ω–∞'];
            
            const employees = [];
            
            console.log('\n=== –ü–û–ò–°–ö –°–û–¢–†–£–î–ù–ò–ö–û–í ===');
            
            for (let i = 0; i < names.length; i++) {
                const name = names[i];
                const nameIndex = text.indexOf(name);
                if (nameIndex === -1) {
                    console.log(`\n${name}: –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                    continue;
                }
                
                console.log(`\n–ù–∞–π–¥–µ–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫: ${name} (–ø–æ–∑–∏—Ü–∏—è ${nameIndex})`);
                
                // –ù–∞—Ö–æ–¥–∏–º –Ω–∞—á–∞–ª–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–∏–ª–∏ –∫–æ–Ω–µ—Ü —Ç–µ–∫—Å—Ç–∞)
                let nextEmployeeIndex = text.length;
                for (let j = i + 1; j < names.length; j++) {
                    const nextIndex = text.indexOf(names[j], nameIndex);
                    if (nextIndex > nameIndex && nextIndex < nextEmployeeIndex) {
                        nextEmployeeIndex = nextIndex;
                    }
                }
                
                // –ë–µ—Ä—ë–º —Ç–µ–∫—Å—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                const textUntilNext = text.substring(nameIndex + name.length, nextEmployeeIndex);
                
                console.log('–¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ –∏–º–µ–Ω–∏ (–¥–ª–∏–Ω–∞):', textUntilNext.length);
                
                // –ò—â–µ–º –¥–æ–ª–∂–Ω–æ—Å—Ç—å (–¥–æ –≥–æ—Ä–æ–¥–∞/–≤–æ–∑—Ä–∞—Å—Ç–∞)
                const cityAgeMatch = textUntilNext.match(/([^\n,]+?,\s*\d+\s*(?:–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞))/);
                if (!cityAgeMatch) {
                    console.log('–ù–µ –Ω–∞–π–¥–µ–Ω –≥–æ—Ä–æ–¥/–≤–æ–∑—Ä–∞—Å—Ç');
                    continue;
                }
                
                const cityAge = cityAgeMatch[1].trim();
                const positionEnd = cityAgeMatch.index;
                const position = textUntilNext.substring(0, positionEnd).trim();
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å–∫–ª–æ–Ω–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
                const correctedCityAge = correctAgeForm(cityAge);
                
                console.log('–î–æ–ª–∂–Ω–æ—Å—Ç—å:', position);
                console.log('–ì–æ—Ä–æ–¥/–≤–æ–∑—Ä–∞—Å—Ç:', correctedCityAge);
                
                const employee = {
                    fullName: name,
                    position: position,
                    cityAge: correctedCityAge,
                    description: '',
                    additionalText: '',
                    photo: ''
                };
                
                // –ò—â–µ–º —Ñ–æ—Ç–æ
                const photoMatch = textUntilNext.match(/https:\/\/disk\.360\.yandex\.ru\/i\/[^\s\)]+/i);
                if (photoMatch) {
                    employee.photo = photoMatch[0];
                    console.log('–§–æ—Ç–æ:', employee.photo);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏ –∏–∑ —Å—Å—ã–ª–∫–∏ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫
                    // –°—Å—ã–ª–∫–∞ –≤–∏–¥–∞ https://disk.360.yandex.ru/i/xxxxx -> –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π URL –Ω–∞ file.dalee.ru
                    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø–æ–ª–Ω–∏—Ç –≤—Ä—É—á–Ω—É—é
                }
                
                // –ò—â–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ - —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –≥–æ—Ä–æ–¥–∞/–≤–æ–∑—Ä–∞—Å—Ç–∞
                const descStart = positionEnd + cityAgeMatch[0].length;
                let textAfterCityAge = textUntilNext.substring(descStart);
                
                // –û–±—Ä–µ–∑–∞–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –ø–æ–¥–ø–∏—Å—å—é HR (–û–∫—Å–∞–Ω–∞ –í–∞—á–µ–≤—Å–∫–∏—Ö)
                const hrSignatureIndex = textAfterCityAge.indexOf('–û–∫—Å–∞–Ω–∞ –í–∞—á–µ–≤—Å–∫–∏—Ö');
                if (hrSignatureIndex > 0) {
                    textAfterCityAge = textAfterCityAge.substring(0, hrSignatureIndex);
                }
                
                // –¢–∞–∫–∂–µ –æ–±—Ä–µ–∑–∞–µ–º –ø–µ—Ä–µ–¥ "–í—Å–µ–º —Å–ø–∞—Å–∏–±–æ" (–∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ç–µ–∫—Å—Ç)
                const outroIndex = textAfterCityAge.indexOf('–í—Å–µ–º —Å–ø–∞—Å–∏–±–æ');
                if (outroIndex > 0) {
                    textAfterCityAge = textAfterCityAge.substring(0, outroIndex);
                }
                
                // –£–±–∏—Ä–∞–µ–º "–§–û–¢–û:", "–∞ –§–û–¢–û:", "—Ñ–æ—Ç–æ:" –∏ —Å—Å—ã–ª–∫–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
                textAfterCityAge = textAfterCityAge
                    .replace(/(?:–∞\s*)?(?:–§–û–¢–û|—Ñ–æ—Ç–æ):\s*/gi, '')
                    .replace(/https:\/\/disk\.360\.yandex\.ru\/i\/[^\s\)]+\s*/gi, '')
                    .trim();
                
                if (textAfterCityAge.length > 20) {
                    employee.description = textAfterCityAge;
                    console.log('–û–ø–∏—Å–∞–Ω–∏–µ (–ø–µ—Ä–≤—ã–µ 50 —Å–∏–º–≤–æ–ª–æ–≤):', textAfterCityAge.substring(0, 50));
                }
                
                employees.push(employee);
                console.log('‚úÖ –°–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω');
            }
            
            console.log('\n=== –ò–¢–û–ì–ò ===');
            console.log('–í—Å–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', employees.length);
            employees.forEach((emp, i) => {
                console.log(`${i + 1}. ${emp.fullName || '???'} - ${emp.cityAge || '???'} - –§–æ—Ç–æ: ${emp.photo ? '–¥–∞' : '–Ω–µ—Ç'}`);
            });
            
            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (employees.length > 0) {
                employees.forEach(emp => {
                    // –†–∞–∑–±–∏—Ä–∞–µ–º URL —Ñ–æ—Ç–æ –Ω–∞ —á–∞—Å—Ç–∏
                    const urlMatch = emp.photo?.match(/dalee_sotrud\/([^\/]+)\/(.+)$/);
                    addEmployeeForm({
                        fullName: emp.fullName,
                        position: emp.position,
                        cityAge: emp.cityAge,
                        description: emp.description,
                        additionalText: emp.additionalText,
                        photo: emp.photo,
                        photoTask: urlMatch ? urlMatch[1] : '',
                        photoImage: urlMatch ? urlMatch[2] : ''
                    });
                });
                
                updatePreview();
                saveToStorage();
                
                // –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏, –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ
                const task = document.getElementById('photoTask')?.value.trim();
                if (task) {
                    updateAllPhotoUrls();
                }
                
                alert(`‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${employees.length}\n\n‚úÖ –í—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω—ã–π –∏ –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —Ç–µ–∫—Å—Ç—ã –∏–∑–≤–ª–µ—á–µ–Ω—ã!\n\n–¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏ —Å–∫–∞—á–∞–π—Ç–µ HTML!`);
            } else {
                console.error('‚ùå –°–û–¢–†–£–î–ù–ò–ö–ò –ù–ï –†–ê–°–ü–û–ó–ù–ê–ù–´');
                console.error('–¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:', text.substring(0, 1000));
                alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.\n\n–û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12) –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –ª–æ–≥–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.');
            }
        }
        
        // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–∫—Å—Ç–∞ –∏–∑ DOCX
        function parseDOCXText(text) {
            // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
            document.getElementById('employeesForms').innerHTML = '';
            formCounter = 0;
            
            // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –±–ª–æ–∫–∏ (–∫–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ - –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫)
            // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç:
            // –§–ò–û
            // –î–æ–ª–∂–Ω–æ—Å—Ç—å
            // –ì–æ—Ä–æ–¥, –≤–æ–∑—Ä–∞—Å—Ç
            // –û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–±–∑–∞—Ü–µ–≤)
            
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const employees = [];
            let currentEmployee = null;
            let collectingDescription = false;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∏
                if (!line || line.startsWith('–í—Å–µ–º –ø—Ä–∏–≤–µ—Ç') || line.startsWith('–î–∞–≤–∞–π—Ç–µ –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è')) {
                    continue;
                }
                
                // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–∑—Ä–∞—Å—Ç (—á–∏—Å–ª–æ –∏ "–≥–æ–¥" –∏–ª–∏ "–ª–µ—Ç"), —ç—Ç–æ –≥–æ—Ä–æ–¥ –∏ –≤–æ–∑—Ä–∞—Å—Ç
                if (/\d+\s*(–≥–æ–¥|–ª–µ—Ç|–≥–æ–¥–∞)/i.test(line) && !collectingDescription) {
                    if (currentEmployee) {
                        employees.push(currentEmployee);
                    }
                    currentEmployee = {
                        fullName: '',
                        position: '',
                        cityAge: line,
                        description: '',
                        additionalText: ''
                    };
                    collectingDescription = false;
                    continue;
                }
                
                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –≥–æ—Ä–æ–¥ –∏ –≤–æ–∑—Ä–∞—Å—Ç, –Ω–æ –Ω–µ—Ç –§–ò–û, —ç—Ç–æ –§–ò–û
                if (currentEmployee && currentEmployee.cityAge && !currentEmployee.fullName && line.length < 100) {
                    currentEmployee.fullName = line;
                    continue;
                }
                
                // –ï—Å–ª–∏ —É –Ω–∞—Å –µ—Å—Ç—å –§–ò–û –∏ –≥–æ—Ä–æ–¥, –Ω–æ –Ω–µ—Ç –¥–æ–ª–∂–Ω–æ—Å—Ç–∏, —ç—Ç–æ –¥–æ–ª–∂–Ω–æ—Å—Ç—å
                if (currentEmployee && currentEmployee.fullName && currentEmployee.cityAge && !currentEmployee.position && line.length < 150) {
                    currentEmployee.position = line;
                    collectingDescription = true;
                    continue;
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—Å–µ –ø–æ–ª—è, —ç—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ
                if (currentEmployee && collectingDescription) {
                    if (currentEmployee.description) {
                        currentEmployee.description += '<br><br>' + line;
                    } else {
                        currentEmployee.description = line;
                    }
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (currentEmployee) {
                employees.push(currentEmployee);
            }
            
            // –°–æ–∑–¥–∞—ë–º —Ñ–æ—Ä–º—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            if (employees.length > 0) {
                employees.forEach(emp => {
                    addEmployeeForm({
                        fullName: emp.fullName,
                        position: emp.position,
                        cityAge: emp.cityAge,
                        description: emp.description,
                        additionalText: emp.additionalText,
                        photo: '',
                        photoTask: '',
                        photoImage: ''
                    });
                });
                
                updatePreview();
                saveToStorage();
                alert(`–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ${employees.length}\n\n–¢–µ–ø–µ—Ä—å –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ!`);
            } else {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞.');
            }
        }

        // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ iframe –ø–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É
        function adjustIframeHeight() {
            try {
                const iframe = document.getElementById('previewFrame');
                if (iframe && iframe.contentDocument && iframe.contentDocument.body) {
                    const contentHeight = iframe.contentDocument.body.scrollHeight;
                    iframe.style.height = (contentHeight + 20) + 'px';
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –≤—ã—Å–æ—Ç—ã iframe:', e);
            }
        }
        
        // –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ —Ç–µ–∫—Å—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Typograf)
        function applyTypography(text) {
            if (!text) return '';

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–º–µ–Ω—è–µ–º Typograf, –ø–æ—Ç–æ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
            let result = typograf.execute(text);
            result = applyAdditionalTypography(result);

            return result;
        }
        
        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS –≤ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ
        function escapeHTML(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        function generateHTML(employeesToRender = null) {
            const employeesList = employeesToRender || employees;
            
            const introText = document.getElementById('introText').value;
            const outroText = document.getElementById('outroText').value;
            const headerLogo = DEFAULT_HEADER_LOGO;
            const hrName = document.getElementById('hrName').value;
            const hrPosition = document.getElementById('hrPosition').value;
            const useTypography = document.getElementById('typographyEnabled').checked;
            
            // –§—É–Ω–∫—Ü–∏—è-–æ–±—ë—Ä—Ç–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∏
            const typography = (text) => useTypography ? applyTypography(text) : text;

            const employeeBlocks = employeesList.map((emp, index) => {
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º HTML –≤ –ø–æ–ª—è—Ö –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS
                const safePhoto = escapeHTML(emp.photo);
                const safeFullName = escapeHTML(emp.fullName);
                const safePosition = escapeHTML(emp.position);
                const safeCityAge = escapeHTML(emp.cityAge);
                const safeDescription = emp.description; // –£–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç <br>, –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
                const safeAdditionalText = emp.additionalText; // –£–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç <br>, –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
                
                let html = `
        <tr>
            <td class="two-columns"
                style="-webkit-font-smoothing:subpixel-antialiased;font-size:0;padding-left:10px;padding-right:10px;text-align:center${index > 0 ? ';border-top:1px solid #eeeeee;padding-top: 20px;' : ''}">
                <!--[if (gte mso 9)|(IE)]><table width="100%"><tr><td width="50%" valign="top"><![endif]-->
                <div class="column"
                     style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:290px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="10" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased"><img width="270" src="${safePhoto}" style="width:100%" onerror="this.style.display='none'"></td>
                        </tr>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;padding-top:0">
                                <div class="paragraph"
                                     style="-webkit-font-smoothing:subpixel-antialiased;color:#333;font-family:helvetica,arial;font-size:14px;line-height:20px;text-align:left">
                                    ${typography(safeFullName)}

                                </div>
                                <div class="paragraph quote"
                                     style="-webkit-font-smoothing:subpixel-antialiased;color:#999;font-family:helvetica,arial;font-size:14px;font-style:italic;line-height:20px;text-align:left">
                                    ${typography(safePosition)}


                                    <br>
                                    ${typography(safeCityAge)}

                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!--[if (gte mso 9)|(IE)]><td width="50%" valign="top"><![endif]-->
                <div class="column"
                     style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:290px;text-align:left;vertical-align:top;width:100%;">
                    <table width="100%" cellpadding="10" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;">
                                <div class="paragraph"
                                     style="-webkit-font-smoothing:subpixel-antialiased;color:#333;font-family:helvetica,arial;font-size:16px;line-height:26px;text-align:left">

                                    ${typography(safeDescription)}

                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!--[if (gte mso 9)|(IE)]><![endif]-->
            </td>
        </tr>`;

                if (safeAdditionalText) {
                    html += `
        <tr>
            <td class="one-column content"
                style="-webkit-font-smoothing:subpixel-antialiased;font-size:0;padding:0;text-align:center;padding-bottom: 20px;">
                <div class="column"
                     style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:600px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="0" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td width="20"></td>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;">
                                <div class="paragraph" style="-webkit-font-smoothing:subpixel-antialiased;color:#333;font-family:helvetica,arial;font-size:16px;line-height:26px;text-align:left">

                                    ${typography(safeAdditionalText)}

                                </div>
                            </td>
                            <td width="20"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>`;
                }

                return html;
            }).join('\n');

            return `<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        body {
            background-color: #f4f4f4;
            margin: 0
        }

        .outer {
            margin: 0 auto;
            max-width: 600px;
            width: 100%
        }

        .middle .outer {
            background-color: #fff;
            border-radius: 4px
        }

        .footer,
        .header,
        .middle {
            margin: 0 10px;
            text-align: center;
            background-color: #f4f4f4;
            table-layout: fixed;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%
        }

        a {
            color: #07c !important;
            text-decoration: underline
        }

        a span {
            color: #07c
        }

        a img {
            border: 0
        }

        div,
        p,
        td {
            -webkit-font-smoothing: subpixel-antialiased
        }

        table {
            border-collapse: collapse
        }

        .h1 {
            font-family: helvetica, arial;
            font-size: 24px;
            color: #333;
            text-align: left;
            line-height: 30px
        }

        .h2 {
            font-family: helvetica, arial;
            font-size: 18px;
            color: #333;
            text-align: left;
            line-height: 24px
        }

        .paragraph,
        p {
            font-family: helvetica, arial;
            font-size: 14px;
            color: #333;
            text-align: left;
            line-height: 20px
        }

        p {
            Margin: 1em 0
        }

        .quote {
            font-style: italic;
            color: #999
        }

        .cover {
            padding: 0
        }

        .cover img {
            width: 100%;
            height: auto;
            max-width: 600px;
            display: block;
            border-radius: 4px 4px 0 0
        }

        .button {
            width: auto !important;
            margin: auto
        }

        .button td {
            padding: 0
        }

        .button-link {
            font-family: helvetica;
            font-size: 14px;
            color: #fff !important;
            font-weight: 700;
            text-decoration: none;
            background-color: #333;
            border: #333 10px solid;
            padding: 0 10px;
            border-radius: 25px;
            display: inline-block
        }

        .button-link span {
            color: #fff
        }

        .four-columns,
        .one-column,
        .three-columns,
        .two-columns {
            text-align: center;
            font-size: 0
        }

        .four-columns,
        .three-columns,
        .two-columns {
            padding-left: 10px;
            padding-right: 10px
        }

        .column {
            width: 100%;
            display: inline-block;
            vertical-align: top;
            font-size: 14px;
            text-align: left
        }

        .one-column .column {
            max-width: 600px
        }

        .two-columns .column {
            max-width: 290px
        }

        .three-columns .column {
            max-width: 193px
        }

        .four-columns .column {
            max-width: 290px
        }

        .contacts .h1 {
            text-align: center
        }

        .contacts .paragraph {
            text-align: center
        }

        .content {
            padding: 0
        }

        .credits .paragraph {
            color: #999;
            font-size: 12px;
            text-align: center
        }

        .header .h1 {
            text-align: center
        }

        .header .paragraph {
            text-align: center;
            font-size: 11px;
            color: #666
        }

        .logo td {
            text-align: center
        }

        @media only screen and (max-width:400px) {
            .two-columns .column {
                max-width: 100% !important
            }

            .three-columns .column {
                max-width: 49.9% !important
            }

            .four-columns .column {
                max-width: 100% !important
            }
        }

        @media screen and (min-width:401px) and (max-width:635px) {
            .two-columns .column {
                max-width: 50% !important
            }

            .three-columns .column {
                max-width: 33.33% !important
            }

            .four-columns .column {
                max-width: 100% !important
            }
        }
    </style>
</head>

<body style="background-color:#f4f4f4;margin:0">
<div class="middle"
     style="-ms-text-size-adjust:100%;-webkit-font-smoothing:subpixel-antialiased;-webkit-text-size-adjust:100%;background-color:#f4f4f4;margin:0 10px;table-layout:fixed;text-align:center">
    <!--[if (gte mso 9)|(IE)]><table width="600" align="center"><tr><td><![endif]-->
    <table class="outer" cellpadding="0" align="center"
           style="background-color:#fff;border-collapse:collapse;border-radius:4px;margin:0 auto;max-width:600px;width:100%">
        <tbody>
        <tr>
            <td style="-webkit-font-smoothing:subpixel-antialiased;text-align: left;">
                <img src="${headerLogo}" width="600" alt="">
            </td>
        </tr>
        <tr>
            <td class="one-column content"
                style="-webkit-font-smoothing:subpixel-antialiased;font-size:0;padding:0;text-align:center">
                <div class="column"
                     style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:600px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="20" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;padding-bottom:10px">
                                ${typography(introText).split('\n').filter(line => line.trim()).map((line, i) => `
                                <div class="h1"
                                     style="-webkit-font-smoothing:subpixel-antialiased;color:#333;font-family:helvetica,arial;font-size:24px;line-height:30px;text-align:left;${i > 0 ? 'margin-top:14px;' : ''}">
                                    ${typography(line.trim())}
                                </div>
                                `).join('')}
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        ${employeeBlocks}
        <tr>
            <td class="one-column content"
                style="-webkit-font-smoothing:subpixel-antialiased;font-size:0;padding:0;text-align:center">
                <div class="column"
                     style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:600px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="20" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;padding-top:10px">
                                ${typography(outroText).split('\n').filter(line => line.trim()).map((line, i) => `
                                <p style="-webkit-font-smoothing:subpixel-antialiased;margin:0;margin-top:14px;color:#333;font-family:helvetica,arial;font-size:18px;line-height:26px;text-align:left">
                                    ${typography(line.trim())}
                                </p>
                                `).join('')}
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <!--[if (gte mso 9)|(IE)]><![endif]-->
</div>
<div class="footer"
     style="-ms-text-size-adjust:100%;-webkit-font-smoothing:subpixel-antialiased;-webkit-text-size-adjust:100%;background-color:#f4f4f4;margin:0 10px;table-layout:fixed;text-align:center">
    <!--[if (gte mso 9)|(IE)]><table width="600" align="center"><tr><td><![endif]-->
    <table class="outer" cellpadding="0" align="center"
           style="border-collapse:collapse;margin:0 auto;max-width:600px;width:100%">
        <tbody>
        <tr>
            <td class="two-columns" style="-webkit-font-smoothing:subpixel-antialiased;font-size:0;padding-left:10px;padding-right:10px;text-align:center;border-top:1px solid #eeeeee;padding-top: 20px;">
                <!--[if (gte mso 9)|(IE)]><table width="100%"><tr><td width="50%" valign="top"><![endif]-->
                <div class="column"               style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:290px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="10" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;padding-top:20px;">
                                <div class="paragraph" style="-webkit-font-smoothing:subpixel-antialiased;color:#333;font-family:helvetica,arial;font-size:14px;line-height:20px;text-align:left">
                                    <span style="font-weight: normal;">${hrName}</span><br>
                                    <span style="font-weight: normal;">${hrPosition}</span>
                                    <br>
                                    <span style="font-weight: bold;">–î–∞–ª–µ–µ/</span><br>
                                    <span style="font-weight: normal;">www.dalee.ru</span><br>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!--[if (gte mso 9)|(IE)]><td width="50%" valign="top"><![endif]-->
                <div class="column" style="-webkit-font-smoothing:subpixel-antialiased;display:inline-block;font-size:14px;max-width:285px;text-align:left;vertical-align:top;width:100%">
                    <table width="100%" cellpadding="0" style="border-collapse:collapse">
                        <tbody>
                        <tr>
                            <td style="-webkit-font-smoothing:subpixel-antialiased;text-align: right;">
                                <img src="https://nikita-zhilin.file.dalee.ru/dalee_sotrud/DIHR-752_05.07.2024/logo_white.png" width="110" alt="">
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <!--[if (gte mso 9)|(IE)]><![endif]-->
            </td>
        </tr>
        </tbody>
    </table>
    <!--[if (gte mso 9)|(IE)]><![endif]-->
</div>
</body>

</html>`;
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        function updatePreview() {
            const employeesList = getEmployeesFromForms(false); // –ë–µ–∑ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            if (!employeesList) return;

            const html = generateHTML(employeesList);
            const frame = document.getElementById('previewFrame');
            frame.srcdoc = html;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –≤–∫–ª–∞–¥–∫–∞ –∫–æ–¥–∞
            if (currentView === 'code') {
                document.getElementById('codeView').value = html;
            }

            // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
            setTimeout(adjustIframeHeight, 500);
        }

        // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ HTML
        function downloadHTML() {
            const employeesList = getEmployeesFromForms(true); // –° –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

            if (!employeesList || employeesList.length === 0) {
                return; // –í–∞–ª–∏–¥–∞—Ü–∏—è —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∞ alert
            }

            const html = generateHTML(employeesList);
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'newsletter.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º –∏ –∫–æ–¥–æ–º
        let currentView = 'preview';
        let lastGeneratedHTML = '';
        
        function switchView(view) {
            currentView = view;
            const previewContainer = document.getElementById('previewContainer');
            const codeContainer = document.getElementById('codeContainer');
            const btnPreview = document.getElementById('btnPreview');
            const btnCode = document.getElementById('btnCode');
            const btnCopyCode = document.getElementById('btnCopyCode');
            
            if (view === 'preview') {
                previewContainer.style.display = 'block';
                codeContainer.style.display = 'none';
                btnPreview.classList.add('active');
                btnCode.classList.remove('active');
                btnCopyCode.style.display = 'none';
            } else {
                previewContainer.style.display = 'none';
                codeContainer.style.display = 'block';
                btnPreview.classList.remove('active');
                btnCode.classList.add('active');
                btnCopyCode.style.display = 'inline-block';
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const employeesList = getEmployeesFromForms(false);
                if (employeesList) {
                    lastGeneratedHTML = generateHTML(employeesList);
                    document.getElementById('codeView').value = lastGeneratedHTML;
                }
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ HTML-–∫–æ–¥–∞
        function copyCode() {
            const codeView = document.getElementById('codeView');
            if (!codeView.value) return;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Clipboard API
            if (navigator.clipboard) {
                navigator.clipboard.writeText(codeView.value).then(() => {
                    showCopyFeedback('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
                }).catch(err => {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
                    fallbackCopy(codeView);
                });
            } else {
                // –§–æ–ª–ª–±—ç–∫ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                fallbackCopy(codeView);
            }
        }
        
        // –§–æ–ª–ª–±—ç–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ select + execCommand
        function fallbackCopy(textarea) {
            textarea.select();
            textarea.setSelectionRange(0, 99999); // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
            try {
                document.execCommand('copy');
                showCopyFeedback('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!');
            } catch (e) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥');
            }
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
        function showCopyFeedback(message) {
            const btnCopyCode = document.getElementById('btnCopyCode');
            const originalText = btnCopyCode.innerHTML;
            btnCopyCode.innerHTML = '<i class="bi bi-check-circle"></i> ' + message;
            btnCopyCode.classList.remove('btn-outline-secondary');
            btnCopyCode.classList.add('btn-success');
            
            setTimeout(() => {
                btnCopyCode.innerHTML = originalText;
                btnCopyCode.classList.remove('btn-success');
                btnCopyCode.classList.add('btn-outline-secondary');
            }, 2000);
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.getElementById('introText').addEventListener('input', () => { saveToStorage(); updatePreview(); });
        document.getElementById('outroText').addEventListener('input', () => { saveToStorage(); updatePreview(); });
        document.getElementById('hrName').addEventListener('input', () => { saveToStorage(); updatePreview(); });
        document.getElementById('hrPosition').addEventListener('input', () => { saveToStorage(); updatePreview(); });
        document.getElementById('typographyEnabled').addEventListener('change', () => { saveToStorage(); updatePreview(); });
        
        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ –ø–∞–Ω–µ–ª–µ–π
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('leftPanel');
        const rightPanel = document.getElementById('rightPanel');
        const mainRow = document.getElementById('mainRow');
        
        let isResizing = false;
        
        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
            resizerHandle.style.background = '#667eea';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            
            const rowRect = mainRow.getBoundingClientRect();
            const newLeftWidth = e.clientX - rowRect.left;
            const newRightWidth = rowRect.right - e.clientX - 20; // —à–∏—Ä–∏–Ω–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è
            
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –ø–∞–Ω–µ–ª–µ–π
            if (newLeftWidth >= 540 && newRightWidth >= 400) {
                leftPanel.style.flex = '0 0 ' + newLeftWidth + 'px';
                rightPanel.style.flex = '0 0 ' + newRightWidth + 'px';
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                resizerHandle.style.background = '#dee2e6';
            }
        });
        
        // –°–ª—É—à–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ iframe
        document.getElementById('previewFrame').addEventListener('load', adjustIframeHeight);

        // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            // Ctrl+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToStorage();
                return false;
            }
            // Ctrl+E - —ç–∫—Å–ø–æ—Ä—Ç
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportConfig();
                return false;
            }
            // Ctrl+I - –∏–º–ø–æ—Ä—Ç JSON
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                document.getElementById('importFile').click();
                return false;
            }
            // Ctrl+P - –∏–º–ø–æ—Ä—Ç PDF
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                document.getElementById('pdfFile').click();
                return false;
            }
            // Ctrl+D - –∏–º–ø–æ—Ä—Ç DOCX
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                document.getElementById('docxFile').click();
                return false;
            }
            // Ctrl+N - –Ω–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                addEmployeeForm();
                return false;
            }
            // Ctrl+Shift+C - –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
            if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                if (currentView === 'code') {
                    copyCode();
                }
                return false;
            }
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadFromStorage();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ Bootstrap
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(tooltipTriggerEl => {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    </script>
</body>
</html>
